<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Admin Sensors</title>
  <style>
    /* Keep consistent with adminShell look */
    .grid2 { display:grid; grid-template-columns: 1.2fr 0.8fr; gap:16px; }
    .card { background:#fff; border:1px solid #e8e8e8; border-radius:18px; padding:16px; }
    .muted { color:#6b6b6b; font-size:12px; }
    .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .field { display:flex; flex-direction:column; gap:6px; }
    label { font-size:12px; color:#555; }
    input, select {
      padding:10px 12px;
      border-radius:12px;
      border:1px solid #ddd;
      outline:none;
      font-size:14px;
      background:#fff;
    }
    input:focus { border-color:#cfcfcf; }
    .btn {
      padding:10px 14px;
      border-radius:12px;
      border:1px solid #ddd;
      background:#f7f7f7;
      cursor:pointer;
      font-weight:600;
      white-space:nowrap;
    }
    .btn.primary { background:#111; color:#fff; border-color:#111; }
    .btn.danger { background:#fff; border-color:#f0c7c7; color:#b00020; }

    table { width:100%; border-collapse:separate; border-spacing:0; margin-top:12px; }
    th, td { text-align:left; padding:12px; border-bottom:1px solid #eee; vertical-align:top; }
    th { font-size:12px; color:#666; background:#fafafa; position:sticky; top:0; }
    .table-wrap { border:1px solid #e8e8e8; border-radius:16px; overflow:hidden; background:#fff; }

    /* Actions panel inside table */
    .actions {
      display:grid;
      gap:10px;
      min-width: 360px;
    }
    .action-box {
      border:1px solid #eee;
      border-radius:14px;
      padding:10px;
      background:#fcfcfc;
    }
    .action-title { font-size:12px; color:#666; margin-bottom:8px; font-weight:700; }
    .action-row {
      display:grid;
      grid-template-columns: 1fr 1fr 1fr auto;
      gap:8px;
      align-items:center;
    }
    .action-row.small {
      grid-template-columns: 1fr auto;
    }
    .hint { font-size:11px; color:#777; margin-top:6px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
  </style>
</head>

<body>

  <div th:replace="~{fragments/adminShell :: adminShell('sensors','Sensors')}">
    <div th:fragment="content">

    <!-- Top cards: Search + Add new product -->
    <!-- Top cards: Search + Register -->
    <div class="grid2">

      <!-- Search -->
      <div class="card">
        <h2 style="margin:0;">Sensors</h2>
        <div class="muted" style="margin-top:6px;">
          Search by sensor name or ambient area.
        </div>

        <form method="get" action="/admin/sensors" style="margin-top:12px;">
          <div class="row">
            <input name="q" th:value="${q}" placeholder="Search sensor name (e.g., AHU-01)" style="flex:1;" />
            <button class="btn" type="submit">Search</button>
            <a th:href="@{/admin/sensors}" style="text-decoration:none; padding:10px 0;">Clear</a>
          </div>
        </form>
      </div>

      <!-- Register new sensor -->
      <div class="card">
        <h3 style="margin:0;">Register new sensor</h3>
        <div class="muted" style="margin-top:6px;">
          Add a sensor to the registry (metadata only).
        </div>

        <form method="post" action="/admin/sensors/create" style="margin-top:12px;">
          <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
          <input type="hidden" name="q" th:value="${q}">

          <div class="row">
            <div class="field" style="flex:1;">
              <label>Variable / Sensor Name</label>
              <input name="sensorName" required>
            </div>
            <div class="field" style="flex:1;">
              <label>Device Name (Brand)</label>
              <input name="deviceName" required>
            </div>
          </div>

          <div class="row" style="margin-top:10px;">
            <div class="field" style="flex:1;">
              <label>Building</label>
              <input name="building" required>
            </div>
            <div class="field" style="flex:1;">
              <label>Level / Area (Lantai)</label>
              <input name="levelArea" required>
            </div>
          </div>

          <div class="row" style="margin-top:10px;">
            <div class="field" style="flex:1;">
              <label>Ambient Area</label>
              <input name="ambientArea" required>
            </div>
          </div>

          <div class="row" style="margin-top:10px;">
            <div class="field" style="flex:1;">
              <label>Sensor Description</label>
              <input name="sensorDescription">
            </div>
          </div>

          <div class="row" style="margin-top:12px;">
            <button class="btn primary" type="submit">Register Sensor</button>
          </div>
        </form>
      </div>

    </div> <!-- âœ… CLOSE grid2 -->

    <!-- Change Settings (full-width) -->
    <div class="card" style="margin-top:16px;">
      <h3 style="margin:0;">Change Settings</h3>
      <div class="muted" style="margin-top:6px;">
        Thresholds and overload percentage (e.g. 70%).
      </div>

      <form method="post" action="/admin/settings/update" style="margin-top:12px;">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
        <input type="hidden" name="q" th:value="${q}">

        <div class="row">
          <div class="field" style="flex:1;">
            <label>Temp Low</label>
            <input name="tempLow" type="number" step="0.1" required
                  th:value="${settings != null ? settings.temp_low : ''}">
          </div>
          <div class="field" style="flex:1;">
            <label>Temp High</label>
            <input name="tempHigh" type="number" step="0.1" required
                  th:value="${settings != null ? settings.temp_high : ''}">
          </div>
          <div class="field" style="flex:1;">
            <label>Overload Percent</label>
            <input name="overloadPercent" type="number" min="1" max="100" required
                  th:value="${settings != null ? settings.overload_percent : ''}">
          </div>
        </div>

        <div class="row" style="margin-top:12px;">
          <button class="btn primary" type="submit">Save Settings</button>
        </div>
      </form>
    </div>  

    <!-- Temperature Dummy Test -->
    <div class="card" style="margin-top:16px;">
      <h3 style="margin:0;">Test Temperature Event</h3>
      <div class="muted" style="margin-top:6px;">
        Generates one dummy sensor_reading_event row so Event History has data.
      </div>
    
      <form method="post" action="/admin/events/test" style="margin-top:12px;">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
        <input type="hidden" name="q" th:value="${q}">
        <button class="btn" type="submit">Generate Dummy Event</button>
      </form>
    </div>    

    <!-- Sensor Registry table -->
    <div class="card" style="margin-top:16px;">
      <h3 style="margin:0 0 10px 0;">Sensor Registry</h3>
    
      <div class="table-wrap">
        <table>
          <thead>
          <tr>
            <th>Sensor Name</th>
            <th>Device</th>
            <th>Building</th>
            <th>Level/Area</th>
            <th>Ambient Area</th>
            <th>Description</th>
          </tr>
          </thead>
          <tbody>
          <tr th:if="${#lists.isEmpty(sensors)}">
            <td colspan="6">No sensors found.</td>
          </tr>
    
          <tr th:each="s : ${sensors}">
            <td th:text="${s.sensor_name}">sensor</td>
            <td th:text="${s.device_name}">device</td>
            <td th:text="${s.building}">building</td>
            <td th:text="${s.level_area}">level</td>
            <td th:text="${s.ambient_area}">ambient</td>
            <td th:text="${s.sensor_description}">desc</td>
          </tr>
          </tbody>
        </table>
      </div>
    </div>    

    <!-- Sensor Events -->
    <div class="card" style="margin-top:16px;">
      <h3 style="margin:0 0 6px 0;">Event History</h3>
      <div class="muted" style="margin-bottom:10px;">
        Sensor reading events (status indicates OK / OVER / UNDER).
      </div>
    
      <div class="table-wrap">
        <table>
          <thead>
          <tr>
            <th>Time</th>
            <th>Sensor</th>
            <th>Ambient Area</th>
            <th>Temperature</th>
            <th>Status</th>
          </tr>
          </thead>
          <tbody>
          <tr th:if="${#lists.isEmpty(events)}">
            <td colspan="5">No records found.</td>
          </tr>
          <tr th:each="e : ${events}">
            <td th:text="${e.time}" class="mono">time</td>
            <td th:text="${e.sensor_name}">sensor</td>
            <td th:text="${e.ambient_area}">area</td>
            <td th:text="${e.temperature}">temp</td>
            <td th:text="${e.status}">status</td>
          </tr>
          </tbody>
        </table>
      </div>
    </div>    

  </div>
</div>

</body>
</html>
